"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}Object.defineProperty(exports,"__esModule",{value:!0});var React=require("react"),React__default=_interopDefault(React);function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function ownKeys(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function _objectSpread2(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(n),!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _objectWithoutPropertiesLoose(t,e){if(null==t)return{};var n,r,o={},c=Object.keys(t);for(r=0;r<c.length;r++)n=c[r],e.indexOf(n)>=0||(o[n]=t[n]);return o}function _objectWithoutProperties(t,e){if(null==t)return{};var n,r,o=_objectWithoutPropertiesLoose(t,e);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(t);for(r=0;r<c.length;r++)n=c[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(o[n]=t[n])}return o}const RouterContext=React.createContext();function Router({children:t}){const[e,n]=React.useState({currentRoute:window.location.pathname,previousRoute:""});return React.useEffect(()=>{function t(){n(t=>({currentRoute:"/".concat(window.location.pathname).replace("//","/"),previousRoute:t.currentRoute}))}return window.addEventListener("popstate",t),function(){window.removeEventListener("popstate",t)}},[]),React__default.createElement(RouterContext.Provider,{value:_objectSpread2({setRoute:t=>{window.history.pushState({},null,t),n(t=>({currentRoute:window.location.pathname,previousRoute:t.currentRoute}))}},e)},t)}const IS_SSR="undefined"==typeof window,TRANSITION_STATES=["entering","entered","exiting","exited"],NEXT_STEP_MAP=[1,1,3,3];function mapToRegExp([t,e,n],r=!1){const o=normalisePath(n?"".concat(n,"/").concat(e):e),[c,u]=deconstructURL(o);let a=c;return r?a="".concat(c,"\\/.*"):"/"===e&&(a="".concat(c,"\\/")),[new RegExp("".concat(a,"$"),"ig"),u,t]}function TransitionableReactRoute(t){let{path:e,timeout:n=1e3,animateOnMount:r,children:o}=t,c=_objectWithoutProperties(t,["path","timeout","animateOnMount","children"]);const u=Date.now(),a=React.useRef([]),i=React.useRef(n),s=React.useContext(RouterContext),l=s.currentRoute,p="".concat(l,"_").concat(u),[f,R]=React.useState(IS_SSR?[{state:r?0:1,key:p,timestamp:u,currentRoute:l}]:[]);return a.current.length||React__default.Children.forEach(o,t=>{const{path:o,defaultpath:c}=t.props,u=t.type===TransitionableReactRoute,i=_objectSpread2({},t.props,{fullPath:c?"defaultpath":normalisePath("".concat(e||"","/").concat(o)),timeout:n});u&&(i.animateOnMount=r);const s=React__default.cloneElement(t,i);c?a.current.push([/.*/gi,[!1],s]):a.current.push(mapToRegExp([s,o,e],u))}),React.useEffect(()=>{c.transitionstate!==TRANSITION_STATES[2]&&R(t=>{const e=[...t],n=Date.now(),o=checkIfSameParent((last(e)||{}).currentRoute,s.currentRoute,a),c=e.length-1;return e.length>0&&e[c].state<2&&!o&&(e[c]=_objectSpread2({},e[c],{timestamp:n,state:2})),o||e.push({state:r?0:1,key:p,timestamp:n,currentRoute:l}),e})},[l]),React.useEffect(()=>{let t,e=!1;const n=()=>{t=requestAnimationFrame(()=>{!e&&onAnimationEnd(R,i.current),n()})};return t=n(),()=>{e=!0,cancelAnimationFrame(t)}},[]),React.useEffect(()=>{n!==i.current&&(a.current=a.current.map(([t,e,r])=>{return[t,e,n!==r.props.timeout?React__default.cloneElement(r,{timeout:n}):r]}),i.current=n)},[n]),React.useMemo(()=>f.map(({currentRoute:t,key:e,state:n})=>{const r=greedyMatchComponent(a.current,t);return r.component?React__default.createElement(r.component.type,_objectSpread2({key:e},r.component.props,{query:r.query,transitionstate:TRANSITION_STATES[n]})):null}),[f])}function checkIfSameParent(t,e,n){const r=matchRoute(n,t),o=matchRoute(n,e);return o&&r?r[r.length-1]===o[o.length-1]:null}function matchRoute(t,e){if(!e)return null;for(let[n]of t.current){n.lastIndex=0;const t=n.exec(e);if(t)return t}}function onAnimationEnd(t,e){t(t=>{let n=!1;const r=Date.now(),o=[...t];for(let t=0;t<o.length;t++){const c=NEXT_STEP_MAP[o[t].state];r-o[t].timestamp>=e&&c!==o[t].state&&(n=!0,o[t]=_objectSpread2({},o[t],{state:c}))}return n?o.filter(({state:t})=>t<3):t})}function greedyMatchComponent(t,e){t:for(let[n,r,o]of t){n.lastIndex=0;const t=n.exec(e);if(!t)continue;let c={};for(let e=0;e<r.length;e++)if("string"==typeof r[e]&&(c[r[e]]=t[e+1],!t[e+1]))continue t;return{component:o,query:c}}return{component:null,attributes:null}}function deconstructURL(t){const e=t.split("/");return"/"===t?["^",[!1]]:e.filter(t=>!!t).reduce((t,e,n)=>{const r=t[1];return 0===e.indexOf(":")?(r.push(e.substring(1)),["".concat(t[0],"\\/?([^\\/]+)?"),r]):(r.push(!1),n>0?["".concat(t[0],"\\/(").concat(e,")"),r]:["".concat(t[0],"(").concat(e,")"),r])},["^\\/",[]])}function normalisePath(t=""){return t.replace("//","/")}function last(t=[]){return t[t.length-1]}exports.Router=Router,exports.RouterContext=RouterContext,exports.TransitionableReactRoute=TransitionableReactRoute;